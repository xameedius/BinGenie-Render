{% extends "layout.html" %}

{% block title %}Scan Â· BinGenie{% endblock %}

{% block content %}
  <div class="card">
    <form id="scanForm" action="{% url 'predict' %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}

<section>

<style>
  /* Hide camera button on desktop */
  @media (min-width: 768px) {
    #cameraBtn {
      display: none !important;
    }
  }
</style>

<div style="display:flex; gap:6px; margin-top:6px;">

  <label id="cameraBtn"
         for="cameraInput"
         class="btn btn-primary"
         style="
           flex:1;
           display:flex;
           align-items:center;
           justify-content:center;
           text-align:center;
           font-size:13px;
           padding:7px 6px;
           border-radius:6px;
           line-height:1.2;
         ">
    ğŸ“· Scan from Camera
  </label>

  <label for="uploadInput"
         class="btn btn-secondary"
         style="
           flex:1;
           display:flex;
           align-items:center;
           justify-content:center;
           text-align:center;
           font-size:13px;
           padding:7px 6px;
           border-radius:6px;
           line-height:1.2;
         ">
    ğŸ–¼ï¸ Upload Image
  </label>

</div>

<input id="cameraInput"
       type="file"
       name="photo"
       accept="image/*"
       capture="environment"
       style="display:none;">

<input id="uploadInput"
       type="file"
       name="photo"
       accept="image/*"
       style="display:none;">

<p class="muted" id="hintText">
  On mobile, â€œScan from Cameraâ€ opens the camera. On desktop, use webcam below.
</p>

</section>

      <section class="form-section" aria-labelledby="previewHeading">
        <h2 id="previewHeading" class="section-title">Preview</h2>
        <img id="preview" alt="Selected image preview">
      </section>

      <hr id="laptopDivider">

      <section id="laptopWebcamSection" class="form-section" aria-labelledby="webcamHeading">
        <h2 id="webcamHeading" class="section-title">Live camera scan (laptop webcam)</h2>

        <div class="webcam-wrap">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas"></canvas>
        </div>

        <div class="button-row">
          <button id="startCamBtn" type="button" class="btn btn-primary">ğŸ¥ Start Camera</button>
          <button id="captureBtn" type="button" class="btn btn-primary" disabled>ğŸ“¸ Capture Photo</button>
          <button id="stopCamBtn" type="button" class="btn btn-secondary" disabled>âœ– Close Camera</button>
        </div>

        <p class="muted">Tip: Start Camera â†’ Capture â†’ Analyze</p>
      </section>

      <section class="form-section form-section--actions">
        <button id="analyzeBtn" class="btn btn-primary" type="submit" disabled>Analyze</button>
      </section>
    </form>

    <section class="results" aria-live="polite">
      {% if error %}
        <div class="result"><b>âš ï¸ {{ error }}</b></div>
      {% endif %}

      {% if pred %}
        <div class="result">
          {% if pred.is_recyclable %}
            <h2>âœ… Recycle</h2>
          {% else %}
            <h2>ğŸ—‘ï¸ Waste</h2>
          {% endif %}

          <p>
            <b>Detected:</b> {{ pred.label }}<br>
            <b>Confidence:</b> {{ pred.confidence|floatformat:2 }}
          </p>

          {% if pred.note %}
            <p><i>{{ pred.note }}</i></p>
          {% endif %}

          <details>
            <summary>Guess Ranking</summary>
            <ul>
              {% for item in pred.top3 %}
                <li>{{ item.label }} â€” {{ item.score|floatformat:3 }}</li>
              {% endfor %}
            </ul>
          </details>
        </div>
      {% endif %}
    </section>
  </div>
{% endblock %}